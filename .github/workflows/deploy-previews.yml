name: Deploy Template Previews

on:
  push:
    branches: [main]
    paths:
      - "templates-frontend/**"
      - ".github/workflows/deploy-previews.yml"
  workflow_dispatch:
    inputs:
      deploy_all:
        description: "Deploy all templates (not just changed)"
        required: false
        type: boolean
        default: false

jobs:
  deploy-templates:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Detect Templates to Deploy
        id: detect
        run: |
          echo "üîç Detecting templates to deploy..."

          # If manual trigger with deploy_all=true, deploy everything
          if [ "${{ github.event.inputs.deploy_all }}" = "true" ]; then
            echo "üì¶ Manual trigger: Deploying ALL templates"
            ALL_TEMPLATES=$(ls -1 templates-frontend/ | grep -v "^\\." | tr '\n' ',' | sed 's/,$//')
            echo "templates=$ALL_TEMPLATES" >> $GITHUB_OUTPUT
            echo "deploy_all=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Detect changed templates
          CHANGED_DIRS=$(git diff --name-only HEAD^ HEAD | grep '^templates-frontend/' | cut -d'/' -f2 | sort -u)

          if [ -z "$CHANGED_DIRS" ]; then
            echo "‚ÑπÔ∏è  No templates changed"
            echo "templates=" >> $GITHUB_OUTPUT
            echo "deploy_all=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "üì¶ Changed templates:"
          echo "$CHANGED_DIRS"

          CHANGED_LIST=$(echo "$CHANGED_DIRS" | tr '\n' ',' | sed 's/,$//')
          echo "templates=$CHANGED_LIST" >> $GITHUB_OUTPUT
          echo "deploy_all=false" >> $GITHUB_OUTPUT

      - name: Check Existing Deployments on VPS
        if: steps.detect.outputs.templates == '' && steps.detect.outputs.deploy_all != 'true'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            # Check if any previews are deployed
            if [ ! -d "/var/www/previews" ] || [ -z "$(ls -A /var/www/previews 2>/dev/null)" ]; then
              echo "NO_DEPLOYMENTS=true" > /tmp/deployment-status.txt
            else
              echo "NO_DEPLOYMENTS=false" > /tmp/deployment-status.txt
            fi

      - name: Decide Deployment Strategy
        id: strategy
        run: |
          # If no changes detected, check if we need initial deployment
          if [ -z "${{ steps.detect.outputs.templates }}" ]; then
            echo "‚ÑπÔ∏è  No changed templates detected"
            echo "üîç Checking if initial deployment is needed..."
            
            # Deploy all templates on first run
            ALL_TEMPLATES=$(ls -1 templates-frontend/ | grep -v "^\\." | tr '\n' ',' | sed 's/,$//')
            echo "üì¶ Initial deployment: Deploying ALL templates"
            echo "templates=$ALL_TEMPLATES" >> $GITHUB_OUTPUT
            echo "is_initial=true" >> $GITHUB_OUTPUT
          else
            echo "templates=${{ steps.detect.outputs.templates }}" >> $GITHUB_OUTPUT
            echo "is_initial=false" >> $GITHUB_OUTPUT
          fi

      - name: Build Templates
        if: steps.strategy.outputs.templates != ''
        env:
          TEMPLATES_TO_BUILD: ${{ steps.strategy.outputs.templates }}
        run: |
          echo "üöÄ Building templates: $TEMPLATES_TO_BUILD"

          IFS=',' read -ra TEMPLATES <<< "$TEMPLATES_TO_BUILD"

          mkdir -p deployment-package

          for TEMPLATE in "${TEMPLATES[@]}"; do
            echo ""
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "üì¶ Processing: $TEMPLATE"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            
            TEMPLATE_PATH="templates-frontend/$TEMPLATE"
            
            if [ ! -f "$TEMPLATE_PATH/package.json" ]; then
              echo "‚ö†Ô∏è  Skipping $TEMPLATE (not a valid React project)"
              continue
            fi
            
            echo "üî® Building $TEMPLATE..."
            cd "$TEMPLATE_PATH"
            
            # Install dependencies
            if npm ci 2>/dev/null || npm install; then
              echo "‚úÖ Dependencies installed"
            else
              echo "‚ùå Failed to install dependencies for $TEMPLATE"
              cd ../..
              continue
            fi
            
            # Build project
            if npm run build; then
              echo "‚úÖ Build successful for $TEMPLATE"
              
              # Verify dist exists
              if [ ! -d "dist" ]; then
                echo "‚ùå Build completed but dist folder not found"
                cd ../..
                continue
              fi
              
              # Copy to deployment package
              mkdir -p "../../deployment-package/$TEMPLATE"
              cp -r dist "../../deployment-package/$TEMPLATE/"
              
              # Create deployment marker
              echo "TEMPLATE=$TEMPLATE" > "../../deployment-package/$TEMPLATE.env"
              echo "BUILD_SUCCESS=true" >> "../../deployment-package/$TEMPLATE.env"
              echo "BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "../../deployment-package/$TEMPLATE.env"
              
            else
              echo "‚ùå Build failed for $TEMPLATE"
              echo "TEMPLATE=$TEMPLATE" > "../../deployment-package/$TEMPLATE.env"
              echo "BUILD_SUCCESS=false" >> "../../deployment-package/$TEMPLATE.env"
            fi
            
            cd ../..
          done

          echo ""
          echo "‚úÖ All builds completed!"
          echo ""
          echo "üì¶ Deployment package contents:"
          ls -lR deployment-package/ || echo "No deployment package created"

      - name: Upload to VPS
        if: steps.strategy.outputs.templates != ''
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "deployment-package/*"
          target: "/tmp/"
          strip_components: 0
          rm: true
          overwrite: true

      - name: Deploy on VPS
        if: steps.strategy.outputs.templates != ''
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            #!/bin/bash
            set -e

            echo "üöÄ Starting VPS deployment..."

            if [ ! -d "/tmp/deployment-package" ]; then
              echo "‚ùå Deployment package not found!"
              exit 1
            fi

            mkdir -p /var/www/previews
            mkdir -p /var/log/template-deployments

            for ENV_FILE in /tmp/deployment-package/*.env; do
              if [ ! -f "$ENV_FILE" ]; then
                continue
              fi
              
              source "$ENV_FILE"
              
              if [ "$BUILD_SUCCESS" != "true" ]; then
                echo "‚ö†Ô∏è  Skipping $TEMPLATE (build failed)"
                continue
              fi
              
              echo ""
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo "üì¶ Deploying: $TEMPLATE"
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              
              SUBDOMAIN=$(echo "$TEMPLATE" | sed 's/-template$//')
              SUBDOMAIN="preview-$SUBDOMAIN"
              
              MAIN_DOMAIN="${{ secrets.MAIN_DOMAIN }}"
              FULL_DOMAIN="$SUBDOMAIN.$MAIN_DOMAIN"
              DEPLOY_DIR="/var/www/previews/$SUBDOMAIN"
              
              echo "üåê Domain: $FULL_DOMAIN"
              echo "üìÅ Deploy to: $DEPLOY_DIR"
              
              SOURCE_DIR="/tmp/deployment-package/$TEMPLATE/dist"
              
              if [ ! -d "$SOURCE_DIR" ]; then
                echo "‚ùå Source not found: $SOURCE_DIR"
                ls -la /tmp/deployment-package/$TEMPLATE/ 2>/dev/null || true
                continue
              fi
              
              echo "‚úÖ Source verified: $SOURCE_DIR"
              
              mkdir -p "$DEPLOY_DIR"
              
              echo "üì¶ Copying files..."
              rsync -av --delete "$SOURCE_DIR/" "$DEPLOY_DIR/"
              
              chown -R www-data:www-data "$DEPLOY_DIR"
              chmod -R 755 "$DEPLOY_DIR"
              
              if [ ! -f "$DEPLOY_DIR/index.html" ]; then
                echo "‚ùå Deployment failed - index.html not found"
                continue
              fi
              
              echo "‚úÖ Files deployed successfully"
              
              echo "‚öôÔ∏è  Configuring Apache..."
              
              cat > "/etc/apache2/sites-available/$SUBDOMAIN.conf" <<APACHECONF
            <VirtualHost *:80>
                ServerName $FULL_DOMAIN
                ServerAlias www.$FULL_DOMAIN
                DocumentRoot $DEPLOY_DIR
                
                <Directory $DEPLOY_DIR>
                    Options -Indexes +FollowSymLinks
                    AllowOverride All
                    Require all granted
                </Directory>
                
                <IfModule mod_rewrite.c>
                    RewriteEngine On
                    RewriteCond %{REQUEST_FILENAME} !-f
                    RewriteCond %{REQUEST_FILENAME} !-d
                    RewriteCond %{REQUEST_URI} !^/index\\.html$
                    RewriteRule ^ /index.html [L]
                </IfModule>
                
                Header always set X-Frame-Options "SAMEORIGIN"
                Header always set X-Content-Type-Options "nosniff"
                Header always set X-XSS-Protection "1; mode=block"
                
                <IfModule mod_deflate.c>
                    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
                </IfModule>
                
                <IfModule mod_expires.c>
                    ExpiresActive On
                    ExpiresByType image/jpg "access plus 1 year"
                    ExpiresByType image/jpeg "access plus 1 year"
                    ExpiresByType image/gif "access plus 1 year"
                    ExpiresByType image/png "access plus 1 year"
                    ExpiresByType image/svg+xml "access plus 1 year"
                    ExpiresByType text/css "access plus 1 month"
                    ExpiresByType application/javascript "access plus 1 month"
                    ExpiresByType text/html "access plus 0 seconds"
                </IfModule>
                
                ErrorLog \${APACHE_LOG_DIR}/$SUBDOMAIN-error.log
                CustomLog \${APACHE_LOG_DIR}/$SUBDOMAIN-access.log combined
            </VirtualHost>
            APACHECONF
              
              a2ensite "$SUBDOMAIN.conf" 2>/dev/null || true
              
              echo "$(date -u +%Y-%m-%dT%H:%M:%SZ) | $TEMPLATE | $FULL_DOMAIN | SUCCESS" >> /var/log/template-deployments/deployments.log
              
              echo "‚úÖ Deployed: http://$FULL_DOMAIN"
            done

            echo ""
            echo "üîç Testing Apache..."

            if apache2ctl configtest 2>&1 | grep -q "Syntax OK"; then
              echo "‚úÖ Apache config valid"
              systemctl reload apache2
              echo "‚úÖ Apache reloaded"
            else
              echo "‚ùå Apache config error"
              apache2ctl configtest
              exit 1
            fi

            echo ""
            echo "üîê Setting up SSL..."

            for ENV_FILE in /tmp/deployment-package/*.env; do
              if [ ! -f "$ENV_FILE" ]; then
                continue
              fi
              
              source "$ENV_FILE"
              
              if [ "$BUILD_SUCCESS" != "true" ]; then
                continue
              fi
              
              SUBDOMAIN=$(echo "$TEMPLATE" | sed 's/-template$//')
              SUBDOMAIN="preview-$SUBDOMAIN"
              MAIN_DOMAIN="${{ secrets.MAIN_DOMAIN }}"
              FULL_DOMAIN="$SUBDOMAIN.$MAIN_DOMAIN"
              
              echo ""
              echo "üîí Checking SSL for: $FULL_DOMAIN"
              
              DOMAIN_IP=$(dig +short $FULL_DOMAIN @8.8.8.8 | tail -n1)
              SERVER_IP=$(curl -s ifconfig.me)
              
              if [ -z "$DOMAIN_IP" ]; then
                echo "‚ö†Ô∏è  DNS not ready, skip SSL"
                continue
              fi
              
              if [ "$DOMAIN_IP" != "$SERVER_IP" ]; then
                echo "‚ö†Ô∏è  DNS mismatch ($DOMAIN_IP != $SERVER_IP)"
                continue
              fi
              
              echo "‚úÖ DNS verified, installing SSL..."
              
              if certbot --apache -d "$FULL_DOMAIN" --non-interactive --agree-tos --email "${{ secrets.SSL_EMAIL }}" --redirect --expand 2>&1 | tee /var/log/template-deployments/ssl-$SUBDOMAIN.log; then
                echo "‚úÖ SSL installed for $FULL_DOMAIN"
              else
                echo "‚ö†Ô∏è  SSL failed for $FULL_DOMAIN"
              fi
              
              sleep 2
            done

            systemctl reload apache2

            rm -rf /tmp/deployment-package

            echo ""
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "üéâ Deployment Complete!"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo ""
            echo "üìã Deployed sites:"
            ls -1 /var/www/previews/ 2>/dev/null | while read dir; do
              echo "  üåê https://preview-$dir.${{ secrets.MAIN_DOMAIN }}"
            done

      - name: Summary
        if: always()
        run: |
          echo ""
          echo "üìä Deployment Summary"
          echo "===================="
          echo "Templates: ${{ steps.strategy.outputs.templates }}"
          echo "Initial deployment: ${{ steps.strategy.outputs.is_initial }}"
