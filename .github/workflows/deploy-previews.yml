name: Deploy Template Previews (Fixed)

on:
  push:
    branches: [main]
    paths:
      - "templates-frontend/**"

jobs:
  deploy-changed-templates:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"

      - name: Detect Changed Templates
        id: detect
        run: |
          echo "üîç Detecting changed templates..."

          CHANGED_DIRS=$(git diff --name-only HEAD^ HEAD | grep '^templates-frontend/' | cut -d'/' -f2 | sort -u)

          if [ -z "$CHANGED_DIRS" ]; then
            echo "No templates changed"
            echo "changed_templates=" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "üì¶ Changed templates:"
          echo "$CHANGED_DIRS"

          CHANGED_LIST=$(echo "$CHANGED_DIRS" | tr '\n' ',' | sed 's/,$//')
          echo "changed_templates=$CHANGED_LIST" >> $GITHUB_OUTPUT

      - name: Build and Package Templates
        if: steps.detect.outputs.changed_templates != ''
        env:
          CHANGED_TEMPLATES: ${{ steps.detect.outputs.changed_templates }}
        run: |
          echo "üöÄ Starting builds for: $CHANGED_TEMPLATES"

          IFS=',' read -ra TEMPLATES <<< "$CHANGED_TEMPLATES"

          # Create deployment directory
          mkdir -p deployment-package

          for TEMPLATE in "${TEMPLATES[@]}"; do
            echo ""
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "üì¶ Processing: $TEMPLATE"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            
            TEMPLATE_PATH="templates-frontend/$TEMPLATE"
            
            if [ ! -f "$TEMPLATE_PATH/package.json" ]; then
              echo "‚ö†Ô∏è  Skipping $TEMPLATE (not a valid React project)"
              continue
            fi
            
            echo "üî® Building $TEMPLATE..."
            cd "$TEMPLATE_PATH"
            
            # Install and build
            npm ci || npm install
            
            if npm run build; then
              echo "‚úÖ Build successful for $TEMPLATE"
              
              # Copy dist to deployment package with proper structure
              mkdir -p "../../deployment-package/$TEMPLATE"
              cp -r dist "../../deployment-package/$TEMPLATE/"
              
              # Create deployment marker
              cat > "../../deployment-package/$TEMPLATE.env" << EOF
            TEMPLATE=$TEMPLATE
            BUILD_SUCCESS=true
            BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)
            EOF
                          
                        else
                          echo "‚ùå Build failed for $TEMPLATE"
                          cat > "../../deployment-package/$TEMPLATE.env" << EOF
            TEMPLATE=$TEMPLATE
            BUILD_SUCCESS=false
            EOF
            fi
            
            cd ../..
          done

          echo ""
          echo "‚úÖ All builds completed!"

          # Show what we're uploading
          echo ""
          echo "üì¶ Deployment package contents:"
          ls -lR deployment-package/

      - name: Upload Deployment Package to VPS
        if: steps.detect.outputs.changed_templates != ''
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "deployment-package/*"
          target: "/tmp/"
          strip_components: 0
          rm: true
          overwrite: true

      - name: Deploy to VPS
        if: steps.detect.outputs.changed_templates != ''
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            #!/bin/bash
            set -e

            echo "üöÄ Starting VPS deployment..."

            # Check if deployment package exists
            if [ ! -d "/tmp/deployment-package" ]; then
              echo "‚ùå Deployment package not found!"
              exit 1
            fi

            # Create base directories
            mkdir -p /var/www/previews
            mkdir -p /var/log/template-deployments

            # Process each deployment
            for ENV_FILE in /tmp/deployment-package/*.env; do
              if [ ! -f "$ENV_FILE" ]; then
                continue
              fi
              
              # Load deployment info
              source "$ENV_FILE"
              
              if [ "$BUILD_SUCCESS" != "true" ]; then
                echo "‚ö†Ô∏è  Skipping $TEMPLATE (build failed)"
                continue
              fi
              
              echo ""
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo "üì¶ Deploying: $TEMPLATE"
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              
              # Generate subdomain (remove -template suffix)
              SUBDOMAIN=$(echo "$TEMPLATE" | sed 's/-template$//')
              SUBDOMAIN="preview-$SUBDOMAIN"
              
              MAIN_DOMAIN="${{ secrets.MAIN_DOMAIN }}"
              FULL_DOMAIN="$SUBDOMAIN.$MAIN_DOMAIN"
              DEPLOY_DIR="/var/www/previews/$SUBDOMAIN"
              
              echo "üåê Domain: $FULL_DOMAIN"
              echo "üìÅ Deploy to: $DEPLOY_DIR"
              
              # Verify source exists
              SOURCE_DIR="/tmp/deployment-package/$TEMPLATE/dist"
              if [ ! -d "$SOURCE_DIR" ]; then
                echo "‚ùå Source directory not found: $SOURCE_DIR"
                ls -la /tmp/deployment-package/$TEMPLATE/ || true
                continue
              fi
              
              echo "üì¶ Source verified: $SOURCE_DIR"
              
              # Create deployment directory
              mkdir -p "$DEPLOY_DIR"
              
              # Copy build files
              echo "üì¶ Copying build files..."
              rsync -av --delete "$SOURCE_DIR/" "$DEPLOY_DIR/"
              
              # Set permissions
              chown -R www-data:www-data "$DEPLOY_DIR"
              chmod -R 755 "$DEPLOY_DIR"
              
              # Verify deployment
              if [ -f "$DEPLOY_DIR/index.html" ]; then
                echo "‚úÖ Files deployed successfully"
              else
                echo "‚ùå Deployment verification failed - index.html not found"
                continue
              fi
              
              # Generate Apache config
              echo "‚öôÔ∏è  Generating Apache config..."
              cat > "/etc/apache2/sites-available/$SUBDOMAIN.conf" << EOF
            <VirtualHost *:80>
                ServerName $FULL_DOMAIN
                ServerAlias www.$FULL_DOMAIN
                DocumentRoot $DEPLOY_DIR
                
                <Directory $DEPLOY_DIR>
                    Options -Indexes +FollowSymLinks
                    AllowOverride All
                    Require all granted
                </Directory>
                
                # React Router fallback
                <IfModule mod_rewrite.c>
                    RewriteEngine On
                    RewriteCond %{REQUEST_FILENAME} !-f
                    RewriteCond %{REQUEST_FILENAME} !-d
                    RewriteCond %{REQUEST_URI} !^/index\.html$
                    RewriteRule ^ /index.html [L]
                </IfModule>
                
                # Security headers
                Header always set X-Frame-Options "SAMEORIGIN"
                Header always set X-Content-Type-Options "nosniff"
                Header always set X-XSS-Protection "1; mode=block"
                
                # Compression
                <IfModule mod_deflate.c>
                    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
                </IfModule>
                
                # Browser caching
                <IfModule mod_expires.c>
                    ExpiresActive On
                    ExpiresByType image/jpg "access plus 1 year"
                    ExpiresByType image/jpeg "access plus 1 year"
                    ExpiresByType image/gif "access plus 1 year"
                    ExpiresByType image/png "access plus 1 year"
                    ExpiresByType image/svg+xml "access plus 1 year"
                    ExpiresByType text/css "access plus 1 month"
                    ExpiresByType application/javascript "access plus 1 month"
                    ExpiresByType text/html "access plus 0 seconds"
                </IfModule>
                
                ErrorLog \${APACHE_LOG_DIR}/$SUBDOMAIN-error.log
                CustomLog \${APACHE_LOG_DIR}/$SUBDOMAIN-access.log combined
            </VirtualHost>
            EOF
              
              # Enable site
              a2ensite "$SUBDOMAIN.conf" 2>/dev/null || true
              
              # Log deployment
              echo "$(date -u +%Y-%m-%dT%H:%M:%SZ) | $TEMPLATE | $FULL_DOMAIN | SUCCESS" \
                >> /var/log/template-deployments/deployments.log
              
              echo "‚úÖ Deployed to: http://$FULL_DOMAIN"
            done

            # Test Apache configuration
            echo ""
            echo "üîç Testing Apache configuration..."
            if apache2ctl configtest 2>&1 | grep -q "Syntax OK"; then
              echo "‚úÖ Apache config is valid"
              
              echo "üîÑ Reloading Apache..."
              systemctl reload apache2
              echo "‚úÖ Apache reloaded successfully"
            else
              echo "‚ùå Apache config has errors"
              apache2ctl configtest
              exit 1
            fi

            echo ""
            echo "üîê SSL Certificate Setup"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

            # SSL installation for each template
            for ENV_FILE in /tmp/deployment-package/*.env; do
              if [ ! -f "$ENV_FILE" ]; then
                continue
              fi
              
              source "$ENV_FILE"
              
              if [ "$BUILD_SUCCESS" != "true" ]; then
                continue
              fi
              
              SUBDOMAIN=$(echo "$TEMPLATE" | sed 's/-template$//')
              SUBDOMAIN="preview-$SUBDOMAIN"
              MAIN_DOMAIN="${{ secrets.MAIN_DOMAIN }}"
              FULL_DOMAIN="$SUBDOMAIN.$MAIN_DOMAIN"
              
              echo ""
              echo "üîí Checking SSL for: $FULL_DOMAIN"
              
              # Check DNS
              DOMAIN_IP=$(dig +short $FULL_DOMAIN @8.8.8.8 | tail -n1)
              SERVER_IP=$(curl -s ifconfig.me)
              
              if [ -z "$DOMAIN_IP" ]; then
                echo "‚ö†Ô∏è  DNS not propagated yet, skipping SSL"
                echo "   Run manually: sudo certbot --apache -d $FULL_DOMAIN"
                continue
              fi
              
              if [ "$DOMAIN_IP" != "$SERVER_IP" ]; then
                echo "‚ö†Ô∏è  Domain points to $DOMAIN_IP, server is $SERVER_IP"
                echo "   Update DNS and run: sudo certbot --apache -d $FULL_DOMAIN"
                continue
              fi
              
              echo "‚úÖ DNS verified, installing SSL..."
              
              certbot --apache \
                -d "$FULL_DOMAIN" \
                --non-interactive \
                --agree-tos \
                --email "${{ secrets.SSL_EMAIL }}" \
                --redirect \
                --expand \
                2>&1 | tee /var/log/template-deployments/ssl-$SUBDOMAIN.log
              
              if [ ${PIPESTATUS[0]} -eq 0 ]; then
                echo "‚úÖ SSL installed for $FULL_DOMAIN"
                echo "$(date -u +%Y-%m-%dT%H:%M:%SZ) | $TEMPLATE | $FULL_DOMAIN | SSL_SUCCESS" \
                  >> /var/log/template-deployments/deployments.log
              else
                echo "‚ö†Ô∏è  SSL failed for $FULL_DOMAIN"
                echo "$(date -u +%Y-%m-%dT%H:%M:%SZ) | $TEMPLATE | $FULL_DOMAIN | SSL_FAILED" \
                  >> /var/log/template-deployments/deployments.log
              fi
              
              sleep 2
            done

            echo ""
            echo "üîÑ Final Apache reload..."
            systemctl reload apache2

            # Cleanup
            rm -rf /tmp/deployment-package

            echo ""
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "üéâ Deployment Complete!"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

            echo ""
            echo "üìã Deployed Sites:"
            apache2ctl -S 2>&1 | grep "namevhost" | grep "preview-" | awk '{print "  üåê https://" $4}'

      - name: Deployment Summary
        if: always()
        run: |
          echo ""
          echo "üìä Deployment Summary"
          echo "===================="
          echo "Changed templates: ${{ steps.detect.outputs.changed_templates }}"
