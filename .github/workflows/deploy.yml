name: Deploy Template with Rollback Support

on:
  repository_dispatch:
    types: [deploy_template]

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      USER_ID: ${{ github.event.client_payload.user_id }}
      TEMPLATE: ${{ github.event.client_payload.template }}
      DOMAIN: ${{ github.event.client_payload.domain }}
      WEBHOOK_URL: ${{ github.event.client_payload.webhook_url }}

    steps:
      - name: Notify Deployment Started
        run: |
          curl -X POST "${{ env.WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{"status": "started", "user_id": "${{ env.USER_ID }}", "template": "${{ env.TEMPLATE }}", "domain": "${{ env.DOMAIN }}"}'

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"
          cache-dependency-path: "templates-frontend/${{ env.TEMPLATE }}/package-lock.json"

      - name: Build Template
        id: build
        run: |
          echo "üî® Building template: ${{ env.TEMPLATE }}"
          cd templates-frontend/${{ env.TEMPLATE }}

          # Install dependencies
          npm ci

          # Build project
          npm run build

          # Verify build output exists
          if [ ! -d "dist" ]; then
            echo "‚ùå Build failed: dist folder not found"
            exit 1
          fi

          echo "‚úÖ Build successful"
          echo "BUILD_SUCCESS=true" >> $GITHUB_OUTPUT

      - name: Notify Build Failed
        if: failure() && steps.build.outcome == 'failure'
        run: |
          curl -X POST "${{ env.WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{"status": "failed", "stage": "build", "user_id": "${{ env.USER_ID }}", "error": "Build process failed"}'
          exit 1

      # üî• BACKUP EXISTING DEPLOYMENT
      - name: Backup Current Deployment
        if: success()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            BACKUP_DIR="/var/backups/deployments/${{ env.USER_ID }}"
            DEPLOY_DIR="/var/www/saas-deployments/${{ env.USER_ID }}/dist"

            if [ -d "$DEPLOY_DIR" ] && [ "$(ls -A $DEPLOY_DIR)" ]; then
              echo "üì¶ Creating backup of existing deployment..."
              mkdir -p "$BACKUP_DIR"
              
              TIMESTAMP=$(date +%Y%m%d-%H%M%S)
              tar -czf "$BACKUP_DIR/backup-$TIMESTAMP.tar.gz" -C "$DEPLOY_DIR" .
              
              echo "‚úÖ Backup created: backup-$TIMESTAMP.tar.gz"
              
              # Keep only last 5 backups
              cd "$BACKUP_DIR"
              ls -t *.tar.gz 2>/dev/null | tail -n +6 | xargs -r rm -f
              echo "üßπ Old backups cleaned"
            else
              echo "‚ÑπÔ∏è No existing deployment to backup"
            fi

      # üî• CREATE DEPLOYMENT DIRECTORY
      - name: Prepare Deployment Directory
        if: success()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "üìÅ Preparing deployment directory..."

            # Create directories
            mkdir -p /var/www/saas-deployments/${{ env.USER_ID }}/dist
            mkdir -p /var/backups/deployments/${{ env.USER_ID }}
            mkdir -p /var/log/deployments

            # Set ownership
            chown -R www-data:www-data /var/www/saas-deployments/${{ env.USER_ID }}

            # Set permissions
            chmod -R 755 /var/www/saas-deployments/${{ env.USER_ID }}

            echo "‚úÖ Directory ready"

      # üî• UPLOAD BUILD FILES
      - name: Upload Build to VPS
        id: upload
        if: success()
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "templates-frontend/${{ env.TEMPLATE }}/dist/*"
          target: "/var/www/saas-deployments/${{ env.USER_ID }}/dist/"
          strip_components: 4
          rm: true
          overwrite: true

      - name: Rollback on Upload Failure
        if: failure() && steps.upload.outcome == 'failure'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "‚ö†Ô∏è Upload failed! Attempting rollback..."

            BACKUP_DIR="/var/backups/deployments/${{ env.USER_ID }}"
            DEPLOY_DIR="/var/www/saas-deployments/${{ env.USER_ID }}/dist"

            if [ -d "$BACKUP_DIR" ]; then
              LATEST_BACKUP=$(ls -t "$BACKUP_DIR"/*.tar.gz 2>/dev/null | head -1)
              
              if [ -f "$LATEST_BACKUP" ]; then
                echo "üîÑ Restoring from: $(basename $LATEST_BACKUP)"
                rm -rf "$DEPLOY_DIR"/*
                tar -xzf "$LATEST_BACKUP" -C "$DEPLOY_DIR"
                echo "‚úÖ Rollback successful"
                
                # Notify rollback
                curl -X POST "${{ env.WEBHOOK_URL }}" \
                  -H "Content-Type: application/json" \
                  -d '{"status": "failed", "stage": "upload", "user_id": "${{ env.USER_ID }}", "rolled_back": true}'
              else
                echo "‚ùå No backup found for rollback"
              fi
            fi
            exit 1

      # üî• VERIFY UPLOAD
      - name: Verify Upload
        if: success()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            DEPLOY_DIR="/var/www/saas-deployments/${{ env.USER_ID }}/dist"

            if [ ! -f "$DEPLOY_DIR/index.html" ]; then
              echo "‚ùå Upload verification failed: index.html not found"
              exit 1
            fi

            echo "‚úÖ Upload verified successfully"

      # üî• CONFIGURE APACHE
      - name: Configure Apache Virtual Host
        id: apache
        if: success()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            DOMAIN="${{ env.DOMAIN }}"
            USER_ID="${{ env.USER_ID }}"

            echo "üåê Configuring Apache for $DOMAIN..."

            # Create Apache configuration
            cat > /etc/apache2/sites-available/${USER_ID}.conf << 'EOF'
            <VirtualHost *:80>
                ServerName DOMAIN_PLACEHOLDER
                ServerAlias www.DOMAIN_PLACEHOLDER
                DocumentRoot /var/www/saas-deployments/USER_ID_PLACEHOLDER/dist
                
                <Directory /var/www/saas-deployments/USER_ID_PLACEHOLDER/dist>
                    Options -Indexes +FollowSymLinks
                    AllowOverride All
                    Require all granted
                    
                    # Security headers
                    Header always set X-Frame-Options "SAMEORIGIN"
                    Header always set X-Content-Type-Options "nosniff"
                    Header always set X-XSS-Protection "1; mode=block"
                </Directory>
                
                # React Router fallback
                <IfModule mod_rewrite.c>
                    RewriteEngine On
                    RewriteBase /
                    RewriteCond %{REQUEST_FILENAME} !-f
                    RewriteCond %{REQUEST_FILENAME} !-d
                    RewriteCond %{REQUEST_URI} !^/index\.html$
                    RewriteRule . /index.html [L]
                </IfModule>
                
                # Enable compression
                <IfModule mod_deflate.c>
                    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
                </IfModule>
                
                # Browser caching
                <IfModule mod_expires.c>
                    ExpiresActive On
                    ExpiresByType image/jpg "access plus 1 year"
                    ExpiresByType image/jpeg "access plus 1 year"
                    ExpiresByType image/gif "access plus 1 year"
                    ExpiresByType image/png "access plus 1 year"
                    ExpiresByType text/css "access plus 1 month"
                    ExpiresByType application/javascript "access plus 1 month"
                    ExpiresByType text/html "access plus 0 seconds"
                </IfModule>
                
                ErrorLog ${APACHE_LOG_DIR}/USER_ID_PLACEHOLDER-error.log
                CustomLog ${APACHE_LOG_DIR}/USER_ID_PLACEHOLDER-access.log combined
            </VirtualHost>
            EOF

            # Replace placeholders
            sed -i "s|DOMAIN_PLACEHOLDER|$DOMAIN|g" /etc/apache2/sites-available/${USER_ID}.conf
            sed -i "s|USER_ID_PLACEHOLDER|$USER_ID|g" /etc/apache2/sites-available/${USER_ID}.conf

            # Disable site if already enabled (to avoid conflicts)
            a2dissite ${USER_ID}.conf 2>/dev/null || true

            # Enable site
            a2ensite ${USER_ID}.conf

            # Test Apache configuration
            if ! apache2ctl configtest 2>&1 | grep -q "Syntax OK"; then
              echo "‚ùå Apache configuration test failed"
              a2dissite ${USER_ID}.conf
              systemctl reload apache2
              exit 1
            fi

            # Reload Apache
            systemctl reload apache2

            echo "‚úÖ Apache configured successfully for $DOMAIN"

      - name: Rollback on Apache Failure
        if: failure() && steps.apache.outcome == 'failure'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "‚ö†Ô∏è Apache configuration failed! Rolling back..."

            # Disable failed site
            a2dissite ${{ env.USER_ID }}.conf 2>/dev/null || true

            # Reload Apache
            systemctl reload apache2

            # Notify failure
            curl -X POST "${{ env.WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '{"status": "failed", "stage": "apache", "user_id": "${{ env.USER_ID }}", "error": "Apache configuration failed"}'
            exit 1

      # üî• SETUP SSL CERTIFICATE
      - name: Setup SSL Certificate
        if: success()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            DOMAIN="${{ env.DOMAIN }}"

            echo "üîê Setting up SSL for $DOMAIN..."

            # Wait a moment for DNS propagation
            sleep 5

            # Check if domain resolves to this server
            DOMAIN_IP=$(dig +short $DOMAIN 2>/dev/null | grep -E '^[0-9.]+$' | head -n1)
            SERVER_IP=$(curl -s --max-time 5 ifconfig.me 2>/dev/null || hostname -I | awk '{print $1}')

            echo "Domain IP: $DOMAIN_IP"
            echo "Server IP: $SERVER_IP"

            if [ -n "$DOMAIN_IP" ] && [ "$DOMAIN_IP" = "$SERVER_IP" ]; then
              echo "‚úÖ Domain points to this server. Installing SSL..."
              
              # Get SSL certificate
              certbot --apache \
                -d $DOMAIN \
                -d www.$DOMAIN \
                --non-interactive \
                --agree-tos \
                --email ${{ secrets.SSL_EMAIL }} \
                --redirect \
                --expand \
                2>&1 | tee /tmp/certbot-output.log
              
              if [ ${PIPESTATUS[0]} -eq 0 ]; then
                echo "‚úÖ SSL certificate installed successfully"
              else
                echo "‚ö†Ô∏è SSL installation had issues. Check logs."
                cat /tmp/certbot-output.log
              fi
            else
              echo "‚ö†Ô∏è Domain not pointing to this server yet."
              echo "Please point $DOMAIN to $SERVER_IP"
              echo "Then run manually: certbot --apache -d $DOMAIN -d www.$DOMAIN"
              echo "Site is accessible via HTTP for now."
            fi
        continue-on-error: true

      # üî• SET FILE PERMISSIONS
      - name: Set Correct Permissions
        if: success()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "üîí Setting correct permissions..."

            DEPLOY_DIR="/var/www/saas-deployments/${{ env.USER_ID }}"

            # Set ownership
            chown -R www-data:www-data "$DEPLOY_DIR"

            # Set directory permissions
            find "$DEPLOY_DIR" -type d -exec chmod 755 {} \;

            # Set file permissions
            find "$DEPLOY_DIR" -type f -exec chmod 644 {} \;

            echo "‚úÖ Permissions set correctly"

      # üî• LOG DEPLOYMENT
      - name: Log Deployment
        if: success()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
            LOG_FILE="/var/log/deployments/deployments.log"

            echo "$TIMESTAMP | USER: ${{ env.USER_ID }} | TEMPLATE: ${{ env.TEMPLATE }} | DOMAIN: ${{ env.DOMAIN }} | STATUS: SUCCESS" >> "$LOG_FILE"

            echo "‚úÖ Deployment logged"

      # üî• NOTIFY SUCCESS
      - name: Notify Deployment Complete
        if: success()
        run: |
          DEPLOYED_AT=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          curl -X POST "${{ env.WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"status\": \"live\",
              \"user_id\": \"${{ env.USER_ID }}\",
              \"template\": \"${{ env.TEMPLATE }}\",
              \"domain\": \"${{ env.DOMAIN }}\",
              \"url\": \"https://${{ env.DOMAIN }}\",
              \"deployed_at\": \"$DEPLOYED_AT\",
              \"success\": true
            }"

          echo "üéâ Deployment completed successfully!"
          echo "üåê Site URL: https://${{ env.DOMAIN }}"

      # üî• CLEANUP ON FAILURE
      - name: Cleanup on Failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "üßπ Cleaning up failed deployment..."

            TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
            LOG_FILE="/var/log/deployments/deployments.log"

            echo "$TIMESTAMP | USER: ${{ env.USER_ID }} | TEMPLATE: ${{ env.TEMPLATE }} | DOMAIN: ${{ env.DOMAIN }} | STATUS: FAILED" >> "$LOG_FILE"

            echo "‚ùå Deployment failed and logged"
